<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3×3 行列掛け算チャレンジ</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 2rem;
    }
    h1 { font-size: 1.75rem; margin: 0; }
    #timer { font-size: 1.5rem; }
    table { border-collapse: collapse; margin: 0.5rem; }
    td {
      width: 2.5rem;
      height: 2.5rem;
      text-align: center;
      border: 1px solid #bbb;
    }
    input[type="number"] {
      width: 2.5rem;
      height: 2.5rem;
      text-align: center;
      border: 1px solid #888;
      border-radius: 4px;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      background: #4f46e5;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:disabled { opacity: 0.4; cursor: default; }
    #score { font-size: 1.25rem; margin-top: 0.5rem; }
    #result { font-weight: bold; }
    #matrices {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>3×3 行列掛け算チャレンジ</h1>
  <div id="timer">10:00</div>

  <div id="matrices"></div>

  <form id="answerForm"></form>

  <div style="display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center;">
    <button id="submitBtn" type="button">回答する</button>
    <button id="skipBtn"   type="button">スキップ</button>
    <button id="csvBtn"    type="button">CSV ダウンロード</button>
  </div>

  <div id="score">正解数: <span id="correct">0</span> / <span id="total">0</span></div>
  <div id="result"></div>

  <script>
    const RAND_MIN = -5, RAND_MAX = 5;
    const DURATION_SEC = 600;

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateMatrix() {
      return Array.from({ length: 3 }, () => Array.from({ length: 3 }, () => randomInt(RAND_MIN, RAND_MAX)));
    }

    function multiply(a, b) {
      const c = Array.from({ length: 3 }, () => Array(3).fill(0));
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          for (let k = 0; k < 3; k++) {
            c[i][j] += a[i][k] * b[k][j];
          }
        }
      }
      return c;
    }

    function matrixToTable(matrix, editable = false, prefix = "") {
      const table = document.createElement("table");
      matrix.forEach((row, i) => {
        const tr = document.createElement("tr");
        row.forEach((val, j) => {
          const td = document.createElement("td");
          if (editable) {
            const input = document.createElement("input");
            input.type = "number";
            input.name = `${prefix}${i}${j}`;
            input.required = true;
            td.appendChild(input);
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      return table;
    }

    let currentA, currentB, currentC;
    let correctCount = 0, totalCount = 0;
    let remaining = DURATION_SEC;
    let timerId;

    const matricesDiv = document.getElementById("matrices");
    const answerForm = document.getElementById("answerForm");
    const submitBtn  = document.getElementById("submitBtn");
    const skipBtn    = document.getElementById("skipBtn");
    const csvBtn     = document.getElementById("csvBtn");
    const timerEl    = document.getElementById("timer");
    const correctEl  = document.getElementById("correct");
    const totalEl    = document.getElementById("total");
    const resultEl   = document.getElementById("result");

    const attempts = [];

    function countCorrectComponents() {
      const userVals = [];
      const correctVals = currentC.flat();
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          const input = answerForm.elements[`cell${i}${j}`];
          const v = Number(input.value);
          if (isNaN(v)) return null;
          userVals.push(v);
        }
      }
      return userVals.filter((v, idx) => v === correctVals[idx]).length;
    }

    function logAttempt(correctComponents) {
      const attempt = {
        timestamp_utc      : new Date().toISOString(),
        correctComponents  : correctComponents,
        matrixA            : currentA,
        matrixB            : currentB,
        correctC           : currentC,
        userAnswer         : Array.from(answerForm.elements).map(e => Number(e.value))
      };
      attempts.push(attempt);
      window.dispatchEvent(new CustomEvent("matrixAttempt", { detail: attempt }));
    }

    function nextProblem() {
      answerForm.innerHTML = "";
      matricesDiv.innerHTML = "";
      currentA = generateMatrix();
      currentB = generateMatrix();
      currentC = multiply(currentA, currentB);

      matricesDiv.appendChild(matrixToTable(currentA));
      matricesDiv.appendChild(Object.assign(document.createElement("div"), {textContent:"×", style: "font-size:1.5rem;margin:0.25rem;"}));
      matricesDiv.appendChild(matrixToTable(currentB));
      matricesDiv.appendChild(Object.assign(document.createElement("div"), {textContent:"=", style: "font-size:1.5rem;margin:0.25rem;"}));
      answerForm.appendChild(matrixToTable(Array.from({length:3}, () => Array(3).fill("")), true, "cell"));
    }

    function handleSubmit() {
      if (!answerForm.checkValidity()) { answerForm.reportValidity(); return; }
      const nCorrect = countCorrectComponents();
      if (nCorrect === null) return;
      totalCount++;
      if (nCorrect === 9) correctCount++;
      correctEl.textContent = correctCount;
      totalEl.textContent   = totalCount;
      logAttempt(nCorrect);
      resultEl.textContent = nCorrect === 9 ? "全問正解！" : `部分正解 (${nCorrect}/9)`;
      nextProblem();
    }

    function handleSkip() {
      totalCount++;
      totalEl.textContent = totalCount;
      logAttempt(0);
      resultEl.textContent = "スキップしました。次の問題へ。";
      nextProblem();
    }

    function downloadCsv() {
      if (attempts.length === 0) return;
      let csv = "timestamp_utc,correct_components,total_components\n";
      csv += attempts.map(a => `${a.timestamp_utc},${a.correctComponents},9`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url;
      a.download = `matrix_log_${new Date().toISOString().replace(/[:.]/g, "-")}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateTimer() {
      if (remaining <= 0) {
        clearInterval(timerId);
        submitBtn.disabled = true;
        skipBtn.disabled   = true;
        answerForm.querySelectorAll("input").forEach(i => i.disabled = true);
        resultEl.textContent = `終了！正解数は ${correctCount} / ${totalCount}`;
        downloadCsv();
        return;
      }
      remaining--;
      const m = String(Math.floor(remaining / 60)).padStart(2, "0");
      const s = String(remaining % 60).padStart(2, "0");
      timerEl.textContent = `${m}:${s}`;
    }

    answerForm.addEventListener("submit", e => { e.preventDefault(); handleSubmit(); });
    submitBtn.addEventListener("click", handleSubmit);
    skipBtn.addEventListener("click", handleSkip);
    csvBtn.addEventListener("click", downloadCsv);

    nextProblem();
    timerId = setInterval(updateTimer, 1000);
  </script>
</body>
</html>
