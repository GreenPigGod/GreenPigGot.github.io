<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3×3 行列掛け算チャレンジ</title>
  <style>
    :root {
      --green: #c8f7c5;
      --red: #f7c5c5;
    }
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 2rem;
    }
    h1 { font-size: 1.75rem; margin: 0; }
    #timer { font-size: 1.5rem; }
    table { border-collapse: collapse; margin: 0.5rem; }
    td {
      width: 2.5rem;
      height: 2.5rem;
      text-align: center;
      border: 1px solid #bbb;
    }
    input[type="number"] {
      width: 2.5rem;
      height: 2.5rem;
      text-align: center;
      border: 1px solid #888;
      border-radius: 4px;
      outline: none;
    }
    input.correct { background: var(--green); }
    input.wrong   { background: var(--red);   }
    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      background: #4f46e5;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:disabled { opacity: 0.4; cursor: default; }
    #score { font-size: 1.25rem; margin-top: 0.5rem; }
    #result { font-weight: bold; }
    #matrices {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    #problem {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <h1>3×3 行列掛け算チャレンジ</h1>
  <div id="timer">10:00</div>
  <div id="problem">
    <div id="matrices">
      <table>
  <tr>
    <td><input type="number" value="1"></td>
    <td><input type="number" value="2"></td>
    <td><input type="number" value="3"></td>
  </tr>
  <tr>
    <td><input type="number" value="4"></td>
    <td><input type="number" value="5"></td>
    <td><input type="number" value="6"></td>
  </tr>
  <tr>
    <td><input type="number" value="7"></td>
    <td><input type="number" value="8"></td>
    <td><input type="number" value="9"></td>
  </tr>
</table>

    </div>
    <div id="answerArea"></div>
  </div>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center;">
    <button id="submitBtn" type="button">回答する</button>
    <button id="skipBtn"   type="button">スキップ</button>
    <button id="csvBtn"    type="button">CSV ダウンロード</button>
    <button id="logBtn"    type="button">入力ログDL</button>
  </div>
  <div id="score">正解数: <span id="correct">0</span> / <span id="total">0</span></div>
  <div id="result"></div>
<script>
const RAND_MIN = -5, RAND_MAX = 5;
const DURATION_SEC = 600;
const $ = (sel) => document.querySelector(sel);
function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function generateMatrix() {
  return Array.from({ length: 3 }, () => Array.from({ length: 3 }, () => randomInt(RAND_MIN, RAND_MAX)));
}
function multiply(a, b) {
  const c = Array.from({ length: 3 }, () => Array(3).fill(0));
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      for (let k = 0; k < 3; k++) c[i][j] += a[i][k] * b[k][j];
    }
  }
  return c;
}
function matrixTable(matrix, editable = false, prefix = "") {
  const table = document.createElement("table");
  matrix.forEach((row, i) => {
    const tr = document.createElement("tr");
    row.forEach((val, j) => {
      const td = document.createElement("td");
      if (editable) {
        const input = document.createElement("input");
        Object.assign(input, {
          type: "number",
          name: `${prefix}${i}${j}`,
          dataset: { row: i, col: j }
        });
        td.appendChild(input);
      } else td.textContent = val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
  return table;
}
let currentA, currentB, currentC;
let correctMatrices = 0, totalMatrices = 0;
let remaining = DURATION_SEC, timerId;
const attempts = [], inputLogs = [];
const matricesDiv = $("#matrices");
const submitBtn   = $("#submitBtn");
const skipBtn     = $("#skipBtn");
const csvBtn      = $("#csvBtn");
const logBtn      = $("#logBtn");
const timerEl     = $("#timer");
const correctEl   = $("#correct");
const totalEl     = $("#total");
const resultEl    = $("#result");
function nextProblem() {
  matricesDiv.innerHTML = "";
  currentA = generateMatrix();
  currentB = generateMatrix();
  currentC = multiply(currentA, currentB);
  matricesDiv.appendChild(matrixTable(currentA));
  matricesDiv.appendChild(exprSpan("×"));
  matricesDiv.appendChild(matrixTable(currentB));
  matricesDiv.appendChild(exprSpan("="));
  const answerTable = matrixTable(Array.from({length:3},() => Array(3).fill("")), true, "cell");
  matricesDiv.appendChild(answerTable);
  const inputs = answerTable.querySelectorAll("input");
  inputs[0].focus();
  inputs.forEach((input, idx) => {
    const r = Math.floor(idx / 3), c = idx % 3;
    input.dataset.row = r; input.dataset.col = c;
    input.addEventListener("input", (e) => handleCellInput(e, r, c, inputs));
    input.addEventListener("keydown", (e) => handleArrowNav(e, inputs));
  });
}
function exprSpan(char){
  return Object.assign(document.createElement("div"),{textContent:char,style:"font-size:1.5rem;margin:0.25rem;"});
}
function handleCellInput(e, r, c, inputs){
  const val = Number(e.target.value);
  if(Number.isNaN(val)) { e.target.classList.remove("correct","wrong"); return; }
  const isCorrect = val === currentC[r][c];
  e.target.classList.toggle("correct", isCorrect);
  e.target.classList.toggle("wrong",   !isCorrect);
  if(isCorrect && !e.target.disabled) {
    e.target.disabled = true;
    inputLogs.push({
      timestamp: new Date().toISOString(),
      row: r,
      col: c,
      value: val,
      correct: currentC[r][c]
    });
    const next = [...inputs].find(inp => !inp.disabled);
    if(next) next.focus();
  }
  if([...inputs].every(inp => inp.disabled)) {
    matricesSolved(9);
  }
}
function handleArrowNav(e, inputs){
  const keyMap = { ArrowRight:1, ArrowLeft:-1, ArrowDown:3, ArrowUp:-3 };
  if(!(e.key in keyMap)) return;
  e.preventDefault();
  let idx = [...inputs].indexOf(e.target) + keyMap[e.key];
  if(idx < 0) idx += 9; if(idx >= 9) idx -= 9;
  inputs[idx].focus();
}
function matricesSolved(correctComponents){
  totalMatrices++; correctMatrices++;
  updateScore();
  logAttempt(correctComponents);
  resultEl.textContent = "全問正解！次へ進みます";
  setTimeout(nextProblem, 600);
}
function handleSubmit(){
  const inputs = matricesDiv.querySelectorAll("input");
  const vals = [...inputs].map(inp => Number(inp.value));
  const correctVals = currentC.flat();
  const nCorrect = vals.filter((v,i)=>v===correctVals[i]).length;
  totalMatrices++;
  if(nCorrect===9) correctMatrices++;
  updateScore();
  logAttempt(nCorrect);
  resultEl.textContent = nCorrect===9 ? "全問正解！" : `部分正解 (${nCorrect}/9)`;
  nextProblem();
}
function handleSkip(){
  totalMatrices++; updateScore();
  logAttempt(0);
  resultEl.textContent = "スキップしました。次の問題へ。";
  nextProblem();
}
function updateScore(){
  correctEl.textContent = correctMatrices;
  totalEl.textContent   = totalMatrices;
}
function logAttempt(correctComponents){
  const attempt = {
    timestamp_utc: new Date().toISOString(),
    correctComponents,
    matrixA: currentA,
    matrixB: currentB,
    correctC: currentC
  };
  attempts.push(attempt);
}
function downloadCsv(){
  if(!attempts.length) return;
  let csv = "timestamp_utc,correct_components\n";
  csv += attempts.map(a => `${a.timestamp_utc},${a.correctComponents}`).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  Object.assign(document.createElement("a"),{href:url,download:`matrix_log_${Date.now()}.csv`}).click();
  URL.revokeObjectURL(url);
}
function downloadLogCsv(){
  if(!inputLogs.length) return;
  let csv = "timestamp,row,col,value,correct\n";
  csv += inputLogs.map(log => `${log.timestamp},${log.row},${log.col},${log.value},${log.correct}`).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  Object.assign(document.createElement("a"),{href:url,download:`input_log_${Date.now()}.csv`}).click();
  URL.revokeObjectURL(url);
}
function updateTimer(){
  if(--remaining < 0){ endGame(); return; }
  const m = String(Math.floor(remaining/60)).padStart(2,"0");
  const s = String(remaining%60).padStart(2,"0");
  timerEl.textContent = `${m}:${s}`;
}
function endGame(){
  clearInterval(timerId);
  matricesDiv.querySelectorAll("input").forEach(inp=>inp.disabled=true);
  submitBtn.disabled = skipBtn.disabled = logBtn.disabled = true;
  resultEl.textContent = `終了！正解数は ${correctMatrices} / ${totalMatrices}`;
  // スコア用CSV
  downloadCsv();
  // 成分ごとの入力ログCSV（正解でロックされた瞬間の時刻入り）
  downloadLogCsv();
} / ${totalMatrices}`;
  downloadCsv();
}
submitBtn.addEventListener("click", handleSubmit);
skipBtn.addEventListener("click", handleSkip);
csvBtn.addEventListener("click", downloadCsv);
logBtn.addEventListener("click", downloadLogCsv);
nextProblem();
timerId = setInterval(updateTimer,1000);
</script>
</body>
</html>
